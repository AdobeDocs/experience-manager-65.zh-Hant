---
title: 正在配置監視的資料夾終結點
seo-title: Configuring watched folder endpoints
description: 瞭解如何配置受監視的資料夾終結點。
seo-description: Learn how to configure watched folder endpoints.
uuid: 01fb5ff8-2071-44bd-9241-7d5d41a5b26e
contentOwner: admin
content-type: reference
geptopics: SG_AEMFORMS/categories/managing_endpoints
products: SG_EXPERIENCEMANAGER/6.4/FORMS
discoiquuid: 761e7909-43ba-4642-bcfc-8d76f139b9a3
exl-id: ec169a01-a113-47eb-8803-bd783ea2c943
source-git-commit: 9d142ce9e25e048512440310beb05d762468f6a2
workflow-type: tm+mt
source-wordcount: '7163'
ht-degree: 0%

---

# 正在配置監視的資料夾終結點 {#configuring-watched-folder-endpoints}

管理員可以配置網路資料夾，稱為 *監視資料夾*&#x200B;這樣，當用戶將檔案(如PDF檔案)放在監視資料夾中時，就會調用已配置的服務操作並操作該檔案。 服務執行指定操作後，會將修改的檔案保存到指定的輸出資料夾中。

## 配置受監視資料夾服務 {#configuring-the-watched-folder-service}

在配置受監視資料夾終結點之前，請配置受監視資料夾服務。 監視資料夾服務的配置參數有兩個用途：

* 配置所有監視資料夾終結點的公用屬性
* 為所有監視的資料夾終結點提供預設值

配置「受監視資料夾」服務後，將為目標服務添加「受監視資料夾」終結點。 添加終結點時，您會設定值，如在將檔案或資料夾放置在已配置的「監視資料夾」服務的輸入資料夾中時要調用的服務名稱和操作名稱。 有關配置「監視資料夾」服務的詳細資訊，請參閱 [已監視資料夾服務設定](/help/forms/using/admin-help/configure-service-settings.md#watched-folder-service-settings)。

## 建立受監視資料夾 {#creating-a-watched-folder}

可以通過以下兩種方式建立受監視資料夾：

* 配置受監視資料夾終結點的設定時，在「路徑」框中鍵入父目錄的完整路徑，並附加要建立的受監視資料夾的名稱，如本示例所示：
   `  C:\MyPDFs\MyWatchedFolder`由於MyStatedFolder資料夾尚不存在，AEM因此表單會嘗試在該位置建立它。

* 在配置受監視的資料夾終結點之前，在檔案系統上建立資料夾，然後在「路徑」框中鍵入完整路徑。

在群集環境中，將用作監視資料夾的資料夾必須可訪問、可寫，並在檔案系統或網路上共用。 在此方案中，群集的每個應用程式伺服器實例必須具有對同一共用資料夾的訪問權限。

在Windows中，如果應用程式伺服器作為服務運行，則必須通過以下方式之一以適當訪問共用資料夾的方式啟動它：

* 將應用程式伺服器服務登錄為 **參數** 以特定用戶的身份啟動，該用戶具有對共用監視資料夾的適當訪問權限。
* 將應用程式伺服器服務「啟動為本地系統」選項配置為允許服務與案頭交互。 此選項要求共用監視的資料夾可以訪問，並且對每個人都可寫。

## 將受監視資料夾連結在一起 {#chaining-together-watched-folders}

可將受監視資料夾連結在一起，以便一個受監視資料夾的結果文檔是下一個受監視資料夾的輸入文檔。 每個受監視資料夾都可以調用不同的服務。 通過以此方式配置受監視的資料夾，可以調用多個服務。 例如，一個受監視的資料夾可以將PDF檔案轉換為Adobe PostScript®，另一個受監視的資料夾可以將PostScript檔案轉換為PDF/A格式。 要執行此操作，只需設定 *結果* 由第一個終結點定義的監視資料夾的資料夾，指向 *輸入* 由第二個終結點定義的監視資料夾的資料夾。

第一次轉換的輸出將轉到\path\result。 第二次轉換的輸入為\path\result，第二次轉換的輸出將轉到\path\result\result （或第二次轉換的結果資料夾框中定義的目錄）。

## 用戶如何與受監視資料夾交互 {#how-users-interact-with-watched-folders}

對於受監視的資料夾終結點，用戶可以通過將輸入檔案或資料夾從案頭複製或拖動到受監視資料夾來調用。 檔案將按檔案到達的順序進行處理。

對於受監視的資料夾終結點，如果作業只需要一個輸入檔案，則用戶可以將該檔案複製到受監視資料夾的根目錄。

如果作業包含多個輸入檔案，則用戶必須在包含所有必需檔案的監視資料夾層次結構外部建立一個資料夾。 此新資料夾應包括輸入檔案（如果進程需要，還可選擇包含DDX檔案）。 構建作業資料夾後，用戶將其複製到監視資料夾的輸入資料夾中。

>[!NOTE]
>
>確保應用程式伺服器已刪除對監視資料夾中檔案的訪問權限。 如AEM果表單在掃描後無法從輸入資料夾中刪除檔案，則將無限期地調用相關進程。

## 已監視資料夾輸出 {#watched-folder-output}

當輸入是資料夾且輸出包含多個檔案時，AEM表單會建立一個與輸入資料夾同名的輸出資料夾，並將輸出檔案複製到該資料夾中。 當輸出包含包含鍵值對的文檔映射時，該鍵將用作輸出檔案名。

端點進程產生的輸出檔案名不能包含字母、數字和句點(.)以外的字元 檔案副檔名之前。 表AEM單將其他字元轉換為十六進位值。

客戶端應用程式從受監視的資料夾結果資料夾中提取結果文檔。 進程錯誤記錄在監視的資料夾故障資料夾中。

## 監視資料夾的工作方式 {#how-watched-folder-works}

「監視資料夾」模組包含以下服務：

* 受監視資料夾服務
* provider.file_scan_service
* provider.file_write_results_service

除了上面列出的服務外，「受監視資料夾」還依賴於其他服務，包括調度作業的調度程式服務和支援目標服務非同步調用的作業管理器服務。

### 監視資料夾如何處理調用請求 {#how-watched-folder-processes-an-invocation-request}

監視資料夾服務處理端點的建立、更新和刪除。 管理員建立端點後，將根據指定的重複間隔或cron表達式安排這些端點由調度程式服務觸發。

此圖說明了「監視資料夾」如何處理調用請求。

![en_watchedfolder](assets/en_watchedfolder.png)

使用受監視資料夾調用服務的過程如下：

1. 客戶端應用程式將檔案或資料夾放置在監視的資料夾輸入資料夾中。
1. 當作業掃描間隔發生時，調度程式服務將調用provider.file_scan_service來處理輸入資料夾中的檔案或資料夾。
1. provider.file_scan_service執行以下任務：


   * 掃描輸入資料夾以查找與包含檔案模式匹配的檔案或資料夾，並排除指定排除檔案模式的檔案或資料夾。 首先選取最舊的檔案或資料夾。 還會拾取早於等待時間的檔案和資料夾。 在一次掃描中，所處理的檔案或資料夾的數量基於批處理大小。 有關檔案模式的資訊，請參見 [關於檔案模式](configuring-watched-folder-endpoints.md#about-file-patterns)。 有關設定批大小的資訊，請參見 [已監視資料夾服務設定](/help/forms/using/admin-help/configure-service-settings.md#watched-folder-service-settings)。
   * 選取要處理的檔案或資料夾。 如果檔案或資料夾未完全下載，則會在下次掃描中拾取它們。 為確保資料夾已完全下載，管理員應使用排除檔案模式建立一個具有名稱的資料夾。 資料夾具有所有檔案後，必須將其更名為包含檔案模式中指定的模式。 此步驟確保資料夾具有調用服務所需的所有必要檔案。 有關確保完全下載資料夾的詳細資訊，請參見 [監視資料夾的提示和技巧](configuring-watched-folder-endpoints.md#tips-and-tricks-for-watched-folders)。
   * 在選擇檔案或資料夾以進行處理後，將其移到舞台資料夾。
   * 根據端點輸入參數映射將階段資料夾中的檔案或資料夾轉換為相應的輸入。 有關輸入參數映射的示例，請參見 [監視資料夾的提示和技巧](configuring-watched-folder-endpoints.md#tips-and-tricks-for-watched-folders)。


1. 為終結點配置的目標服務被同步或非同步調用。 使用為終結點配置的用戶名和密碼調用目標服務。

   * 同步調用直接調用目標服務並立即處理響應。
   * 對於非同步調用，通過作業管理器服務調用目標服務，該服務將請求置於隊列中。 作業管理器服務則調用provider.file_write_results_service來處理結果。

1. provider.file_write_results_service處理目標服務調用的響應或失敗。 成功後，根據端點配置將輸出保存到結果資料夾。 如果端點配置為在成功完成後保留結果，則provider.file_write_results_service還會保留源。

   當調用目標服務導致失敗時，provider.file_write_results_service會將失敗原因記錄在failure.log檔案中，並將該檔案放在failure資料夾中。 根據為端點指定的配置參數建立故障資料夾。 當管理員為端點配置設定「保留失敗時」選項時，provider.file_write_results_service還會將源檔案複製到故障資料夾中。 有關從故障資料夾中恢復檔案的資訊，請參見 [故障點和恢復](configuring-watched-folder-endpoints.md#failure-points-and-recovery)。


## 已監視資料夾終結點設定 {#watched-folder-endpoint-settings}

使用以下設定配置受監視的資料夾終結點。

**名稱：** （必需）標識終結點。 不要包含&lt;字元，因為它將截斷Workspace中顯示的名稱。 如果輸入URL作為終結點的名稱，請確保它符合RFC1738中指定的語法規則。

**描述：** 終結點的說明。 不要包含&lt;字元，因為它將截斷Workspace中顯示的說明。

**路徑：** （必需）指定監視的資料夾位置。 在群集環境中，此設定必須指向可從群集中每台電腦訪問的共用網路資料夾。

**非同步：** 將調用類型標識為非同步或同步。 預設值為非同步。 建議對長壽命進程使用非同步，而對暫時或短壽命進程建議使用同步。

**Cron表達式：** 如果必須使用cron表達式來計畫監視的資料夾，請輸入cron表達式。 配置此設定時，將忽略重複間隔。

**重複間隔：** 掃描監視資料夾以進行輸入的間隔（秒）。 除非啟用「限制」設定，否則「重複間隔」應長於處理平均作業的時間；否則，系統可能會過載。 預設值為 5。有關其它資訊，請參閱批大小的說明。

**重複計數：** 監視資料夾掃描資料夾或目錄的次數。 值為–1表示無限掃描。 預設值為–1。

**限制：** 選擇此選項後，它將限制表單在任意給定時間處AEM理的受監視資料夾作業數。 最大作業數由「批大小」值確定。 （請參閱關於限制。）

**用戶名：** （必需）從受監視資料夾調用目標服務時使用的用戶名。 預設值為SuperAdmin。

**域名：** （必需）用戶的域。 預設值為DefaultDom。

**批大小：** 每次掃描要拾取的檔案或資料夾數。 用於防止系統過載；一次掃描過多檔案可能會導致崩潰。 預設值為 2。

「重複間隔」和「批處理大小」設定確定每個掃描中「監視資料夾」拾取的檔案數。 監視資料夾使用Quartz線程池掃描輸入資料夾。 線程池與其他服務共用。 如果掃描間隔較小，線程將經常掃描輸入資料夾。 如果檔案經常被丟棄到受監視的資料夾中，則應將掃描間隔保持在較小。 如果檔案不常被刪除，請使用更大的掃描間隔，以便其他服務可以使用線程。

如果正在刪除大量檔案，請使批大小變大。 例如，如果受監視資料夾終結點調用的服務每分鐘可處理700個檔案，並且用戶以相同的速率將檔案放入輸入資料夾中，則將「批處理大小」設定為350，將「重複間隔」設定為30秒將幫助監視資料夾效能，而不會導致掃描被監視資料夾的成本過高。

當檔案被放入監視資料夾時，它會在輸入中列出檔案，如果每秒都進行掃描，則會降低效能。 增加掃描間隔可以改善效能。 如果要刪除的檔案量較小，請相應調整批大小和重複間隔。 例如，如果每秒丟棄10個檔案，請嘗試將「重複間隔」設定為1秒，將「批處理大小」設定為10。

**等待時間：** 建立資料夾或檔案後掃描檔案之前等待的時間（毫秒）。 例如，如果等待時間為3,600,000毫秒（一小時），且檔案是在一分鐘前建立的，則該檔案將在59分鐘或更長時間後被拾取。 預設值為 0。

此設定對於確保將檔案或資料夾完全複製到輸入資料夾非常有用。 例如，如果要處理一個大檔案，並且該檔案下載需要10分鐘，請將等待時間設定為10&amp;ast;60 &amp;ast;1000毫秒。 如果檔案未保存10分鐘，則禁止監視資料夾掃描該檔案。

**排除檔案模式：** 分號 **;** 已分隔的模式清單，監視資料夾用於確定要掃描和拾取的檔案和資料夾。 不會掃描任何具有此模式的檔案或資料夾進行處理。

當輸入是包含多個檔案的資料夾時，此設定非常有用。 可以將資料夾的內容複製到名稱由監視資料夾拾取的資料夾中。 這樣，在將監視資料夾完全複製到輸入資料夾之前，監視資料夾將無法拾取要處理的資料夾。

可以使用檔案模式排除：

* 具有特定檔案副檔名的檔案；例如，&amp;ast;.dat、&amp;ast;.xml、&amp;ast;.pdf。
* 具有特定名稱的檔案；例如，資料。&amp;ast;將排除名為 *資料1*。 *資料2*&#x200B;等等。
* 名稱和副檔名中包含複合表達式的檔案，如下例所示：

   * 資料[0-9][0-9][0-9]。[dD][aA]「port」
   * &amp;ast;。[dD][Aa]「port」
   * &amp;ast;。[Xx][毫米][Ll]

有關檔案模式的詳細資訊，請參見 [關於檔案模式](configuring-watched-folder-endpoints.md#about-file-patterns)。

**包括檔案模式：** （強制）分號 **;** 已分隔的模式清單，監視資料夾用於確定要掃描和拾取的資料夾和檔案。 例如，如果「包括檔案模式」為input&amp;ast;，則匹配input&amp;ast的所有檔案和資料夾；被選中。 這包括名為input1、input2等的檔案和資料夾。

預設值為&amp;ast;並指示所有檔案和資料夾。

可以使用檔案模式包括：

* 具有特定檔案副檔名的檔案；例如，&amp;ast;.dat、&amp;ast;.xml、&amp;ast;.pdf。
* 具有特定名稱的檔案；例如，資料。&amp;ast;將包括名為 *資料1*。 *資料2*&#x200B;等等。
* 名稱和副檔名中包含複合表達式的檔案，如下例所示：

   * 資料[0-9][0-9][0-9]。[dD][aA]「port」
   * &amp;ast;。[dD][Aa]「port」
   * &amp;ast;。[Xx][毫米][Ll]

有關檔案模式的詳細資訊，請參見 [關於檔案模式](configuring-watched-folder-endpoints.md#about-file-patterns)。


**結果資料夾：** 儲存保存結果的資料夾。 如果結果未顯示在此資料夾中，請檢查失敗資料夾。 不處理只讀檔案，將保存在故障資料夾中。 此值可以是具有以下檔案模式的絕對路徑或相對路徑：

* %F =檔案名前置詞
* %E =檔案副檔名
* %Y =年（滿）
* %y =年（最後兩位）
* %M =月
* %D =每月的某天
* %d =一年中的某天
* %H =小時（24小時制）
* %h =小時（12小時制）
* %m =分鐘
* %s =秒
* %l =毫秒
* %R =隨機數（介於0和9之間）
* %P =進程或作業ID

例如，如果2009年7月17日晚上8點，並且您指定 `C:/Test/WF0/failure/%Y/%M/%D/%H/`，結果資料夾為 `C:/Test/WF0/failure/2009/07/17/20`。

如果路徑不是絕對的，而是相對的，則會在監視資料夾內建立該資料夾。 預設值是result/%Y/%M/%D/，它是受監視資料夾內的「結果」資料夾。 有關檔案模式的詳細資訊，請參見 [關於檔案模式](configuring-watched-folder-endpoints.md#about-file-patterns)。

>[!NOTE]
>
>結果資料夾的大小越小，「受監視資料夾」的效能就越好。 例如，如果監視資料夾的估計負載是每小時1000個檔案，請嘗試類似 `result/%Y%M%D%H` 這樣每小時就會建立新的子資料夾。 如果負載較小（例如，每天1000個檔案），則可以使用類似 `result/%Y%M%D`。

**保留資料夾：** 成功掃描和拾取後儲存檔案的位置。 路徑可以是絕對路徑、相對路徑或空目錄路徑。 可以使用檔案模式，如「結果資料夾」中所述。 預設值為preserve/%Y/%M/%D/。

**失敗資料夾：** 保存故障檔案的資料夾。 此位置始終相對於監視的資料夾。 可以使用檔案模式，如「結果資料夾」中所述。

不處理只讀檔案，將保存在故障資料夾中。

預設值為failure/%Y/%M/%D/。

**失敗時保留：** 在無法對服務執行操作時保留輸入檔案。 預設值為true。

**覆蓋重複的檔案名：** 設定為True時，結果資料夾和保留資料夾中的檔案將被覆蓋。 如果設定為False，則名稱將使用帶數字索引尾碼的檔案和資料夾。 預設值為False。

**清除持續時間：** （必需）結果資料夾中的檔案和資料夾在它們早於此值時被清除。 此值以天計。 此設定在確保結果資料夾未滿時非常有用。

值為–1天表示從不刪除結果資料夾。 預設值為–1。

**操作名稱：** （必需）可分配給監視資料夾終結點的操作的清單。

**輸入參數映射：** 用於配置處理服務和操作所需的輸入。 可用的設定取決於使用監視資料夾終結點的服務。 以下是兩種輸入：

**文字：** 監視資料夾在顯示時使用在欄位中輸入的值。 支援所有基本Java類型。 例如，如果API使用String、long、int和Boolean等輸入，則字串將轉換為正確的類型並調用服務。

**變數：** 輸入的值是被監視資料夾用於選擇輸入的檔案模式。 例如，在加密密碼服務(其中輸入文檔必須是PDF檔案)的情況下，用戶可以使用&amp;ast;.pdf作為檔案模式。 受監視資料夾將拾取與此模式匹配的受監視資料夾中的所有檔案，並為每個檔案調用服務。 使用變數時，所有輸入檔案都會轉換為文檔。 僅支援使用Document作為輸入類型的API。

**輸出參數映射：** 用於配置服務和操作的輸出。 可用的設定取決於使用監視資料夾終結點的服務。

受監視的資料夾輸出可以是單個文檔、文檔清單或文檔映射。 然後，這些輸出文檔將使用「輸出參數映射」中指定的模式保存在結果資料夾中。

>[!NOTE]
>
>指定導致輸出檔案名唯一的名稱可提高效能。 例如，考慮服務返回一個輸出文檔且輸出參數映射將其映射到的情況 `%F.%E` （輸入檔案的檔案名和副檔名）。 在這種情況下，如果用戶每分鐘刪除具有相同名稱的檔案，並且結果資料夾配置為 `result/%Y/%M/%D`，並且「覆蓋重複檔案名」設定處於關閉狀態，「監視資料夾」將嘗試解析重複的檔案名。 解析重複檔案名的過程可能會影響效能。 在這種情況下，將輸出參數映射更改為 `%F_%h_%m_%s_%l` 向名稱中添加小時、分鐘、秒和毫秒，或確保刪除的檔案具有唯一名稱可能會提高效能。

## 關於檔案模式 {#about-file-patterns}

管理員可以指定可以調用服務的檔案類型。 可為每個監視資料夾建立多個檔案模式。 檔案模式可以是下列檔案屬性之一：

* 具有特定檔案名副檔名的檔案；例如，&amp;ast;.dat、&amp;ast;.xml、&amp;ast;.pdf、
* 具有特定名稱的檔案；例如，資料。&amp;ast;
* 名稱和副檔名中包含複合表達式的檔案，如下例所示：

   * 資料[0-9][0-9][0-9]。[dD][aA]「port」
   * &amp;ast;。[dD][Aa]「port」
   * &amp;ast;。[Xx][毫米][Ll]

管理員可以定義輸出資料夾的檔案模式，以在其中儲存結果。 對於輸出資料夾（結果、保留和失敗），管理員可以指定以下任何檔案模式：

* %Y =年（滿）
* %y =年（最後兩位）
* %M =月，
* %D =月日，
* %d =一年中的某天，
* %h =小時，
* %m =分鐘，
* %s =秒，
* %R = 0-9之間的隨機數
* %J =作業名稱

例如，結果資料夾的路徑可能是 `C:\Adobe\Adobe_Experience_Manager_forms\BarcodedForms\%y\%m\%d`。

輸出參數映射還可以指定其他模式，如：

* %F =源檔案名
* %E =源檔案名副檔名

如果輸出參數映射模式以「File.separator」（即路徑分隔符）結尾，則會建立一個資料夾，並將內容複製到該資料夾中。 如果模式不以「File.separator」結尾，則使用該名稱建立內容（結果檔案或資料夾）。 有關輸出參數映射的詳細資訊，請參見 [監視資料夾的提示和技巧](configuring-watched-folder-endpoints.md#tips-and-tricks-for-watched-folders)。

## 關於限制 {#about-throttling}

當為監視資料夾終結點啟用限制時，它將限制在任何給定時間都可以處理的監視資料夾作業的數量。 最大作業數由批大小值確定，該值也可在「監視資料夾」終結點中配置。 達到限制限制後，將不會輪詢監視資料夾輸入目錄中的傳入文檔。 在完成其他受監視資料夾作業並進行另一輪輪詢嘗試之前，這些文檔還將保留在輸入目錄中。 在同步處理的情況下，在單個輪詢中處理的所有作業都將計入限制，即使這些作業在單個線程中連續處理。

>[!NOTE]
>
>限制不隨群集擴展。 啟用限制後，集群作為一個整體將不會處理超過「批大小」中在任何給定時間指定的作業數。 此限制是群集範圍的，不特定於群集中的每個節點。 例如，如果批大小為2，則單個節點處理兩個作業時可以達到限制限制，並且在完成其中一個作業之前，沒有其他節點會輪詢輸入目錄。

### 限制工作原理 {#how-throttling-works}

「受監視的資料夾」在每個重複間隔掃描輸入資料夾，提取批大小中指定的檔案數，並為每個這些檔案調用目標服務。 例如，如果批大小為4，則每次掃描時，「監視資料夾」將拾取四個檔案，建立四個調用請求並調用目標服務。 在完成這些請求之前，如果調用了「受監視資料夾」，則無論前四個作業是否完成，它都將再次啟動四個作業。

限制阻止監視資料夾在上一個作業未完成時調用新作業。 受監視的資料夾將檢測正在進行的作業，並根據批處理大小減去正在進行的作業來處理新作業。 例如，在第二次調用中，如果已完成的作業數僅為三個，而一個作業仍在進行中，則「監視資料夾」僅調用另外三個作業。

* 「已監視資料夾」依靠階段資料夾中存在的檔案數來確定正在執行的作業數。 如果檔案在階段資料夾中仍未處理，則「監視資料夾」將不再調用任何作業。 例如，如果批處理大小為4，並且停止了3個作業，則「監視資料夾」在後續調用中將只調用一個作業。 存在多種情形，可導致檔案在階段資料夾中保持未處理。 當作業停止時，管理員可以終止表單工作流管理頁面上的進程，以便「監視資料夾」將檔案移出舞台資料夾。
* 如果表單伺服器在「監視資料夾」可以調用作業之前關閉，則管理員可以將檔案移出舞台資料夾。 有關資訊，請參見 [故障點和恢復](configuring-watched-folder-endpoints.md#failure-points-and-recovery)。
* 如果表單伺服器正在運行，但當作業管理器服務回叫時，監視資料夾未運行，當服務未按順序啟動時，管理員可以將檔案移出舞台資料夾。 有關資訊，請參見 [故障點和恢復](configuring-watched-folder-endpoints.md#failure-points-and-recovery)。


## 效能和可擴充性 {#performance-and-scalability}

受監視的資料夾可以在一個節點上共為100個資料夾提供服務。 監視資料夾的效能取決於表單伺服器的效能。 對於非同步調用，效能更依賴於作業管理器隊列中的系統負載和作業。

可以通過向群集添加節點來提高受監視資料夾的效能。 通過Quartz調度器，以及在非同步請求情況下通過作業管理器服務，在群集節點中分佈受監視的資料夾作業。 所有作業都保留在資料庫中。

受監視的資料夾取決於調度程式服務，用於調度、取消調度和重新調度作業。 其他服務（如事件管理服務、用戶管理器服務和電子郵件提供程式服務）可用於共用調度程式服務線程池。 這可能影響「監視資料夾」的效能。 當所有服務都開始使用調度程式服務線程池時，將需要調整它。

## 群集中的監視資料夾 {#watched-folders-in-a-cluster}

在群集中，「受監視資料夾」取決於Quartz計畫程式和Job Manager服務以進行負載平衡和故障轉移。 有關Quartz群集行為的詳細資訊，請參見 [Quartz文檔](https://www.quartz-scheduler.org/documentation)。

監視資料夾在每次輪詢中執行以下三項主要任務：

* 掃描資料夾
* 調用目標服務
* 處理結果

負載平衡和故障轉移行為會根據被監視資料夾是否配置為同步或非同步調用而發生更改。

### 群集中的同步監視資料夾 {#synchronous-watched-folder-in-a-cluster}

對於同步調用，Quartz負載平衡器將決定哪個節點將獲取輪詢事件。 獲取輪詢事件的節點將執行所有任務：掃描資料夾，調用目標服務並處理結果。

![en_synchwatchedfoldercluster](assets/en_synchwatchedfoldercluster.png)

對於同步調用，當一個節點出現故障時，Quartz調度程式會向其他節點發送新的輪詢事件。 在失敗節點上啟動的調用將丟失。 有關如何恢復與失敗作業關聯的檔案的詳細資訊，請參見 [故障點和恢復](configuring-watched-folder-endpoints.md#failure-points-and-recovery)。


### 群集中的非同步監視資料夾 {#asynchronous-watched-folder-in-a-cluster}

對於非同步調用，Quartz負載平衡器將決定哪個節點將獲取輪詢事件。 獲取輪詢事件的節點將掃描輸入資料夾並通過將請求置於作業管理器服務隊列來調用目標服務。 作業管理器服務負載平衡器負責決定哪個節點將處理調用請求。 即使節點A建立了調用請求，節點B也可能最終處理該請求。 或者啟動調用請求的節點也可能最終處理該請求。

![en_asyncwatchedfoldercluster](assets/en_asynchwatchedfoldercluster.png)

對於非同步調用，當一個節點出現故障時，Quartz調度程式會向其他節點發送新的輪詢事件。 在失敗節點上建立的調用請求將位於作業管理器服務隊列中，並將發送到其他節點進行處理。 未為其建立調用請求的檔案將保留在階段資料夾中。 有關如何恢復與失敗作業關聯的檔案的詳細資訊，請參見 [故障點和恢復](configuring-watched-folder-endpoints.md#failure-points-and-recovery)。


## 故障點和恢復 {#failure-points-and-recovery}

在每個輪詢事件中，「監視資料夾」會鎖定輸入資料夾，將與包含檔案模式匹配的檔案移動到階段資料夾，然後解鎖輸入資料夾。 需要鎖定，以便兩個線程不會拾取同一組檔案並處理它們兩次。 發生這種情況的可能性隨著小的重複間隔和大的批量而增加。 將檔案移動到舞台資料夾後，將解鎖輸入資料夾，以便其他線程可以掃描該資料夾。 此步驟有助於提供高吞吐量，因為在一個線程處理檔案時，其他線程可以掃描。

將檔案移動到階段資料夾後，為每個檔案建立調用請求，並調用目標服務。 可能存在「受監視資料夾」無法恢復階段資料夾中的檔案的情況：

* 如果伺服器在「監視資料夾」可以建立調用請求之前關閉，則舞台資料夾中的檔案將保留在舞台資料夾中，並且不會恢復。
* 如果「監視資料夾」已成功為舞台資料夾中的每個檔案建立調用請求，並且伺服器崩潰，則基於調用類型有兩種行為：

**同步：** 如果將「監視資料夾」配置為同步調用服務，則舞台資料夾中的所有檔案在舞台資料夾中仍未處理。

**非同步：** 在這種情況下，「監視資料夾」依賴於「作業管理器」服務。 如果作業管理器服務回叫「監視資料夾」，則根據調用結果將階段資料夾中的檔案移動到保留或失敗資料夾。 如果作業管理器服務未回叫「監視資料夾」，則這些檔案將在階段資料夾中保持未處理。 當作業管理器回叫時，當「監視資料夾」未運行時，會發生這種情況。

### 在階段資料夾中恢復未處理的源檔案 {#recovering-unprocessed-source-files-in-the-stage-folder}

當「監視資料夾」無法處理階段資料夾中的源檔案時，可以恢復未處理的檔案。

1. 重新啟動應用程式伺服器或節點。
1. （可選）停止監視資料夾處理新輸入檔案。 如果跳過此步驟，則很難確定在階段資料夾中未處理哪些檔案。 要阻止監視資料夾處理新輸入檔案，請執行以下任務之一：

   * 在Applications and Services中，將監視資料夾終結點的「包括檔案模式」參數更改為與任何新輸入檔案不匹配的內容(例如，輸入 `NOMATCH`)。
   * 暫停正在建立新輸入檔案的進程。
   等到表AEM單恢復並處理所有檔案。 大部分檔案應恢復，並且所有新輸入檔案都應正確處理。 等待「監視資料夾」恢復和處理檔案的時間長度取決於要調用的操作的長度和要恢復的檔案數量。

1. 確定無法處理的檔案。 如果您等待了適當的時間並完成了上一步，並且在階段資料夾中仍保留未處理的檔案，請轉到下一步。

   >[!NOTE]
   >
   >您可以查看階段目錄中檔案的日期和時間戳。 根據檔案數和正常處理時間，可以確定哪些檔案已足夠老，可以認為是卡住的檔案。

1. 將未處理檔案從階段目錄複製到輸入目錄。
1. 如果在步驟2中阻止「監視資料夾」處理新輸入檔案，請將「包括檔案模式」更改為其上一個值，或重新啟用您禁用的進程。

## 受監視資料夾的安全注意事項 {#security-considerations-for-watched-folders}

每個受監視資料夾都配置了用戶名和密碼。 調用服務時使用這些憑據。 受監視資料夾依賴於共用資料夾受基礎安全檔案系統保護這一事實，因此只有受監視資料夾的所有者才能訪問共用資料夾。

## 監視資料夾的提示和技巧 {#tips-and-tricks-for-watched-folders}

以下是配置「監視資料夾」終結點時的一些提示和技巧：

* 如果Windows上有正在處理影像檔案的監視資料夾，請為「包括檔案模式」或「排除檔案模式」選項指定值，以防止Windows自動生成的Muttes.db檔案被監視資料夾輪詢。
* 如果指定cron表達式，則忽略重複間隔。 cron表達式的使用基於Quartz開源作業調度系統1.4.0版。
* 批處理大小是在監視資料夾的每次掃描中將拾取的檔案或資料夾的數量。 如果批大小設定為兩個，並且在監視的資料夾輸入資料夾中丟棄了十個檔案或資料夾，則每次掃描只會拾取兩個檔案或資料夾。 在下次掃描中，將在重複間隔中指定的時間後進行，接下來的兩個檔案將被拾取。
* 對於檔案模式，管理員可以指定規則運算式，並添加對通配符模式的支援以指定檔案模式。 受監視資料夾修改規則運算式以支援通配符模式，如&amp;ast;。&amp;ast;或&amp;ast;.pdf。 規則運算式不支援這些通配符模式。
* 「受監視資料夾」掃描輸入資料夾以查找輸入，在開始處理檔案或資料夾之前，不知道源檔案或資料夾是否已完全複製到輸入資料夾。 要確保在拾取檔案或資料夾之前將源檔案或資料夾完全複製到監視資料夾的輸入資料夾中，請執行以下任務：

   * 使用等待時間，即監視資料夾從上次修改時間等待的時間（以毫秒為單位）。 如果要處理的檔案較大，請使用此功能。 例如，如果下載檔案需要10分鐘，請將等待時間指定為10&amp;ast;60 &amp;ast;1000毫秒。 如果檔案不是10分鐘的舊檔案，這將阻止「已監視資料夾」拾取該檔案。
   * 使用排除檔案模式並包括檔案模式。 例如，如果排除檔案陣列為 `ex*` 包含檔案模式為 `in*`，「已監視資料夾」將拾取以「in」開頭的檔案，而不會拾取以「ex」開頭的檔案。 要複製大型檔案或資料夾，請首先更名該檔案或資料夾，使名稱以&quot;ex&quot;開頭。 將名為&quot;ex&quot;的檔案或資料夾完全複製到監視的資料夾後，將其更名為&quot;in&amp;ast;&quot;。

* 使用清除持續時間使結果資料夾保持乾淨。 已監視資料夾將清除所有早於清除持續時間的檔案。 持續時間以天為單位。
* 添加監視資料夾終結點時，在選擇操作名稱后，將填充輸入參數映射。 對於操作的每個輸入，生成一個輸入參數映射欄位。 以下是輸入參數映射的示例：

   * 對於 `com.adobe.idp.Document` 輸入：如果服務操作的輸入類型 `Document`，管理員可以將映射類型指定為 `Variable`。 受監視資料夾將根據為輸入參數指定的檔案模式從受監視資料夾的輸入資料夾中拾取輸入。 如果管理員指定 `*.pdf` 作為參數，將選取副檔名為.pdf的每個檔案，並將其轉換為 `com.adobe.idp.Document`和調用的服務。
   * 對於 `java.util.Map` 輸入：如果服務操作的輸入類型 `Map`，管理員可以將映射類型指定為 `Variable` 並輸入具有類似 `*.pdf`。 例如，服務需要兩個映射 `com.adobe.idp.Document` 表示輸入資料夾中兩個檔案的對象，如1.pdf和2.pdf。 受監視資料夾將建立一個映射，其中鍵為檔案名，值為 `com.adobe.idp.Document`。
   * 對於 `java.util.List` 輸入：如果服務操作的輸入類型為「清單」，則管理員可以將映射類型指定為 `Variable` 並輸入具有類似 `*.pdf`。 當PDF檔案被放入輸入資料夾時，「監視資料夾」將建立 `com.adobe.idp.Document` 表示這些檔案並調用目標服務的對象。
   * 對於 `java.lang.String`:管理員有兩個選項。 首先，管理員可以將映射類型指定為 `Literal` 並輸入映射值作為字串，如 `hello.` 受監視的資料夾將使用字串調用服務 `hello`。 其次，管理員可以將映射類型指定為 `Variable` 並輸入具有類似 `*.txt`。 在後一種情況下，副檔名為.txt的檔案將作為文檔被讀取，被強制為字串以調用服務。
   * Java基元類型：管理員可以將映射類型指定為 `Literal` 提供價值。 受監視資料夾將調用指定值的服務。

* 受監視資料夾用於處理文檔。 支援的輸出為 `com.adobe.idp.Document`。 `org.w3c.Document`。 `org.w3c.Node`，以及這些類型的清單和映射。 任何其他類型都會導致故障資料夾中的輸出失敗。
* 如果結果不在結果資料夾中，請驗證失敗資料夾以查看是否發生了故障。
* 如果在非同步模式下使用，則受監視的資料夾最有效。 在此模式下，「受監視資料夾」將調用請求置入隊列並回電。 然後非同步處理該隊列。 如果未設定「非同步」選項，「監視資料夾」將同步調用目標服務，並且進程引擎將等待，直到完成該服務並生成請求和結果。 如果目標服務需要較長時間來處理請求，則「受監視資料夾」可能會出現超時錯誤。
* 為導入和導出操作建立受監視資料夾不允許檔案副檔名抽象。 使用受監視的資料夾調用表單資料整合服務時，輸出檔案的檔案副檔名類型可能與文檔對象類型的預期輸出格式不匹配。 例如，如果調用導出操作的監視資料夾的輸入檔案是包含資料的XFA表單，則輸出應為XDP資料檔案。 要獲得具有正確檔案副檔名的輸出檔案，可以在輸出參數映射中指定該檔案。 在此示例中，可以使用%F.xdp進行輸出參數映射。
* 受監視資料夾可能會在將輸入檔案完全複製到資料夾之前處理它們。 檔案鎖定在UNIX上不是必需的，因為它在Windows上。 因此，當檔案被複製到監視資料夾時，「監視資料夾」可能會將檔案移動到舞台，而不等待檔案副本完成。 此行為僅導致處理一部分輸入檔案。 目前有兩種解決方法：

   * 解決方法1

      1. 指定「排除檔案模式」的模式，如temp&amp;ast;.ps。
      1. 將以temp（例如temp1.ps）開頭的檔案複製到受監視的資料夾。
      1. 將檔案完全複製到監視資料夾後，更名檔案，使其與為「包括檔案模式」指定的模式相對應。 然後，「已監視資料夾」將已完成的檔案移至舞台。
   * 解決方法2

      如果您知道將檔案複製到受監視資料夾所花費的最長時間，請指定等待時間（秒）。 然後，監視的資料夾在將檔案移動到存放之前等待指定的時間長度。

      這對Windows上的檔案不是問題，因為當一個線程正在寫入時，Windows會鎖定檔案。 但是，這是Windows上的資料夾的問題。 對於資料夾，必須執行解決方法1中的步驟。


* 如果「監視資料夾」的「保留資料夾名稱」終結點屬性設定為空目錄路徑，則暫存目錄不會按應清除的方式清除。 目錄仍包含已處理的檔案和臨時資料夾。

## 受監視資料夾的服務特定建議 {#service-specific-recommendations-for-watched-folders}

對於所有服務，您應調整受監視資料夾的批大小和重複間隔，以便受監視資料夾獲取新檔案和資料夾進行處理的速率不超過表單伺服器可處理的作業AEM速率。 實際使用的參數可能因配置的監視資料夾數、使用監視資料夾的服務以及處理器上作業的密集程度而異。

### 生成PDF服務建議 {#generate-pdf-service-recommendations}

* 「生成PDF」服務一次只能轉換下列檔案類型的一個檔案：MicrosoftWord、MicrosoftExcel、MicrosoftPowerPoint、Microsoft項目、AutoCAD、Adobe Photoshop®、Adobe FrameMaker®和AdobePageMaker®。 這些是長期存在的工作；因此，請確保將批大小保持在低設定。 如果群集中有更多節點，還會增加重複間隔。
* 對於PostScript(PS)、封裝的PostScript(EPS)和映像檔案類型，生成PDF服務可以並行處理多個檔案。 您應根據伺服器的容量和群集中節點的數量仔細調整會話Bean池大小（該大小控制將並行進行的轉換數）。 然後，將批處理大小增加到與您嘗試轉換的檔案類型的會話Bean池大小相等的數字。 輪詢頻率應由群集中節點數決定；但是，由於「生成PDF」服務處理此類作業的速度非常快，因此可以將重複間隔配置為低值，如5或10。
* 即使「生成PDF」服務一次只能轉換一個OpenOffice檔案，轉換速度也相當快。 PS、EPS和映像轉換的上述邏輯也適用於OpenOffice轉換。
* 要在群集中實現均勻的負載分佈，請保持批處理大小低並增加重複間隔。

### 條形碼表單服務建議 {#barcoded-forms-service-recommendations}

* 要在處理條形碼表單（小檔案）時獲得最佳效能，請輸入 `10` 對於批大小和 `2` 中。
* 在輸入資料夾中放置許多檔案時，調用隱藏檔案的錯誤 *拇指.db* 可能發生。 因此，建議將包含檔案的「包括檔案模式」設定為為輸入變數指定的相同值(例如， `*.tiff`)。 這會阻止監視資料夾處理資料庫檔案。
* 批大小值 `5` 和重複間隔 `2` 通常是足夠的，因為BarcodedForms服務通常需要大約0.5秒來處理一個條形碼。
* 受監視的資料夾不會等待進程引擎完成作業，然後再選擇新檔案或資料夾。 它繼續掃描監視的資料夾並調用目標服務。 此行為可能使引擎超載，導致資源問題和超時。 確保使用重複間隔和批處理大小來限制「監視資料夾」輸入。 如果存在更多受監視的資料夾或在端點上啟用限制，則可以增加重複間隔並減少批處理大小。 有關限制的資訊，請參見 [關於限制](configuring-watched-folder-endpoints.md#about-throttling)。
* 「監視資料夾」模擬用戶名和域名中指定的用戶。 如果直接調用或進程短時，「受監視的資料夾」將以此用戶身份調用服務。 對於長期進程，該進程將使用系統上下文調用。 管理員可以為「受監視資料夾」設定作業系統策略，以確定允許或拒絕訪問哪個用戶。
* 使用檔案模式來組織結果、失敗和保留資料夾。 (請參閱 [關於檔案模式](configuring-watched-folder-endpoints.md#about-file-patterns)。)

* 「已監視資料夾」依靠Quartz計畫程式掃描已監視的資料夾。 Quartz調度程式具有一個線程池來掃描它們。 如果受監視資料夾的重複間隔非常低（&lt; 5秒），且批大小很高(> 2)，則可能會出現競爭情況。 當出現此情況時，兩個Quartz線程將拾取一個檔案：

   * 其中一個線程成功找到該檔案並使用該檔案調用目標服務。
   * 第二個線程會看到檔案，但在嘗試查找檔案是否有效（讀或寫檔案）時失敗，這會導致錯誤失敗，表明檔案是只讀的，因此無法處理該檔案。 只有在重複間隔較小、批處理大小較高的情況下才會發生這種情況。
